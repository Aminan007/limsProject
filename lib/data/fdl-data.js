
if(typeof JSON!=='object'){JSON={};}
(function(){'use strict';function f(n){return n<10?'0'+n:n;}
if(typeof Date.prototype.toJSON!=='function'){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+'-'+
f(this.getUTCMonth()+1)+'-'+
f(this.getUTCDate())+'T'+
f(this.getUTCHours())+':'+
f(this.getUTCMinutes())+':'+
f(this.getUTCSeconds())+'Z':null;};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf();};}
var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={'\b':'\\b','\t':'\\t','\n':'\\n','\f':'\\f','\r':'\\r','"':'\\"','\\':'\\\\'},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==='string'?c:'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);})+'"':'"'+string+'"';}
function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==='object'&&typeof value.toJSON==='function'){value=value.toJSON(key);}
if(typeof rep==='function'){value=rep.call(holder,key,value);}
switch(typeof value){case'string':return quote(value);case'number':return isFinite(value)?String(value):'null';case'boolean':case'null':return String(value);case'object':if(!value){return'null';}
gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==='[object Array]'){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||'null';}
v=partial.length===0?'[]':gap?'[\n'+gap+partial.join(',\n'+gap)+'\n'+mind+']':'['+partial.join(',')+']';gap=mind;return v;}
if(rep&&typeof rep==='object'){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==='string'){k=rep[i];v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}
v=partial.length===0?'{}':gap?'{\n'+gap+partial.join(',\n'+gap)+'\n'+mind+'}':'{'+partial.join(',')+'}';gap=mind;return v;}}
if(typeof JSON.stringify!=='function'){JSON.stringify=function(value,replacer,space){var i;gap='';indent='';if(typeof space==='number'){for(i=0;i<space;i+=1){indent+=' ';}}else if(typeof space==='string'){indent=space;}
rep=replacer;if(replacer&&typeof replacer!=='function'&&(typeof replacer!=='object'||typeof replacer.length!=='number')){throw new Error('JSON.stringify');}
return str('',{'':value});};}
if(typeof JSON.parse!=='function'){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==='object'){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v;}else{delete value[k];}}}}
return reviver.call(holder,key,value);}
text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return'\\u'+
('0000'+a.charCodeAt(0).toString(16)).slice(-4);});}
if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,'@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,']').replace(/(?:^|:|,)(?:\s*\[)+/g,''))){j=eval('('+text+')');return typeof reviver==='function'?walk({'':j},''):j;}
throw new SyntaxError('JSON.parse');};}}());if(typeof window!='undefined'){if((!("console"in window))){window.console={'log':function(s){}};};}
var Fdl={version:"0.1",_isAuthenticate:null,_isConnected:null,_serverTime:null};Fdl._print_r=function(obj,level,maxlevel){if(!obj)
return'';if(!level)
level=0;if(!maxlevel)
maxlevel=1;if(typeof obj!='object')
return obj.toString();if(level>maxlevel)
return'';var slev='';if(!level)
level=0;for(var i=0;i<level;i++)
slev+='......';var names=obj.toString()+"\n";if('splice'in obj&&'join'in obj)
names='Array';else if(typeof obj=='object')
names=obj.toString();else
names=typeof obj;names+="\n";for(var name in obj){try{if(typeof obj[name]=='function')
names+='';else if(typeof obj[name]=='object')
names+=slev+name+" -"
+Fdl._print_r(obj[name],level+1,maxlevel)+"\n";else
names+=slev+name+" - ["+obj[name]+"]\n";}catch(ex){names+=name+" - ["+"unreadable"+"]\n";}}
return names;};Fdl.print_r=function(obj,maxlevel){if(!maxlevel)
maxlevel=1;var names=Fdl._print_r(obj,0,maxlevel);alert(names);};Fdl.connect=function(config){if(config){if(!this.context)
this.context=new Object();if(config.url){this.context.url=config.url;if(this.context.url.substr(-4,4)=='.php')
this.context.url+='?';else if(this.context.url.substr(-1,1)!='/')
this.context.url+='/';this.url=this.context.url;}}};Fdl.getCookie=function(c_name){if(document.cookie.length>0){c_start=document.cookie.indexOf(c_name+"=");if(c_start!=-1){c_start=c_start+c_name.length+1;c_end=document.cookie.indexOf(";",c_start);if(c_end==-1)
c_end=document.cookie.length;return unescape(document.cookie.substring(c_start,c_end));}}
return"";};Fdl.formatDate=function(isodate,fmt){if(isodate&&fmt&&typeof isodate=='string'){var year=isodate.substring(0,4);var month=isodate.substring(5,7);var day=isodate.substring(8,10);var hour=isodate.substring(11,13);var minute=isodate.substring(14,16);var second=isodate.substring(17,19);var r=fmt;r=r.replace('%d',day);r=r.replace('%m',month);r=r.replace('%Y',year);r=r.replace('%H',hour);r=r.replace('%M',minute);r=r.replace('%S',second);return r;}
return'';};Fdl.isAuthenticated=function(config){if(config&&config.reset)
this._isAuthenticate=null;if(this._isAuthenticate===null){var userdata=Fdl.retrieveData({app:'DATA',action:'USER'});if(userdata){if(userdata.error){Fdl.setErrorMessage(userdata.error);this._isAuthenticate=false;}else{if(!this.user)
this.user=new Fdl.User({data:userdata});this._isAuthenticate=true;}}}
return this._isAuthenticate;};Fdl.setAuthentification=function(config){if(config){if(!config.login){Fdl.setErrorMessage('login not defined');return null;}
if(!config.password){Fdl.setErrorMessage('password not defined');return null;}
var userdata=Fdl.retrieveData({app:'DATA',action:'USER',method:'authent'},config,true);if(userdata.error){this._isAuthenticate=false;Fdl.setErrorMessage(userdata.error);return null;}else{this._isAuthenticate=true;this.user=new Fdl.User({data:userdata});return this.user;}}};Fdl.setErrorMessage=function(msg){if(msg)
this.lastErrorMessage=msg;};Fdl.getLastErrorMessage=function(){return this.lastErrorMessage;};Fdl.retrieveData=function(urldata,parameters,anonymousmode){var bsend='';var ANAKEENBOUNDARY='--------Anakeen www.anakeen.com 2009';var xreq=null;if(typeof window!='undefined'){if(window.XMLHttpRequest){xreq=new XMLHttpRequest();}else if(window.ActiveXObject){xreq=new ActiveXObject("Microsoft.XMLHTTP");}}else{xreq=Components.classes["@mozilla.org/xmlextras/xmlhttprequest;1"].createInstance(Components.interfaces.nsIXMLHttpRequest);}
var sync=true;if(xreq){var url=this.context.url;if(!url)
url='/';if(anonymousmode)
url+='guest.php';else
url+='data.php';xreq.open("POST",url,(!sync));var pvars=true;if(!pvars){xreq.setRequestHeader("Content-type","application/x-www-form-urlencoded");}else{var params='';var ispost=false;xreq.setRequestHeader("Content-Type","multipart/form-data; boundary=\""
+ANAKEENBOUNDARY+"\"");for(var name in urldata){bsend+="\r\n--"+ANAKEENBOUNDARY+"\r\n";bsend+="Content-Disposition: form-data; name=\""+name
+"\"\r\n\r\n";bsend+=urldata[name];}
if(parameters){for(var name in parameters){bsend+="\r\n--"+ANAKEENBOUNDARY+"\r\n";bsend+="Content-Disposition: form-data; name=\""+name
+"\"\r\n\r\n";bsend+=parameters[name];}}}
try{if(bsend.length==0)
xreq.send('');else
xreq.send(bsend);}catch(e){Fdl.setErrorMessage('HTTP status: unable to send request');}
if(xreq.status==200){var r=false;try{r=eval('('+xreq.responseText+')');if(r.error)
Fdl.setErrorMessage(r.error);}catch(ex){alert('error on serveur data');alert(xreq.responseText);}
return r;}else{if(xreq)
Fdl.setErrorMessage('HTTP status:'+xreq.status);}}
return false;};Fdl.isConnected=function(config){if(config&&config.reset)
this._isConnected=null;if(this._isConnected===null&&(typeof this.context=='object')&&this.context.url){var data=Fdl.retrieveData({app:'DATA',action:'USER',method:'ping'},config,true);this._serverTime=null;if(data){if(data.error){Fdl.setErrorMessage(data.error);this._isConnected=false;}else{this._isConnected=true;this._serverTime=data.time;}}}
return this._isConnected;};Fdl.getUser=function(config){if(config){if(config.reset)
this.user=null;}
if(!this.user){this.user=new Fdl.User();}
return this.user;};Fdl.getHiddenTarget=function(config){if(!this._hiddenTarget){this._hiddenTarget='fdlhiddeniframe';if(!config){if(!document.getElementById(this._hiddenTarget)){var o=document.createElement("div");o.innerHTML='<iframe style="display:none;width:100%" id="'
+this._hiddenTarget+'" name="'+this._hiddenTarget
+'"></iframe>';document.body.appendChild(o);}}}
return this._hiddenTarget;};Fdl._completeSave=function(callid,data){var s=Fdl._getWaitSave(parseInt(callid));s.data=data;if(s.document){s.document.affect(data);s.config.callback.call(null,s.document);}
Fdl._clearWaitSave(parseInt(callid));};Fdl._memoWaitSave=[];Fdl._waitSave=function(me,config){Fdl._memoWaitSave.push({document:me,config:config});return Fdl._memoWaitSave.length-1;};Fdl._getWaitSave=function(callid){return Fdl._memoWaitSave[callid];};Fdl._clearWaitSave=function(callid){if(Fdl._memoWaitSave[callid])
Fdl._memoWaitSave[callid]=null;};Fdl.resizeImage=function(icon,width){var u=Fdl.context.url;var src=Fdl.context.url+icon;var ps=u.lastIndexOf('/');if(ps){u=u.substring(0,ps+1);src=u+icon;}
src=u+'resizeimg.php?size='+width+'&img='+escape(src);return src;};Fdl.getTime=function(){var d=new Date();var t=d.getTime();var i='--';if(this._dtime)
i=((t-this._dtime)/1000).toFixed(3);this._dtime=t;return i;};Fdl.json2xml=function(json,node,childs){var root=false;if(!node){node=document.createElement('root');root=true;childs=[];}
if(json===null){node.appendChild(document.createTextNode(''));}else if(typeof json!='object'){node.appendChild(document.createTextNode(json));}else{var found=false;if((typeof json=='object')){for(var i=0;i<childs.length;i++){if(childs[i]===json){childs[i]['_xmlrecursive']=true;if(childs[i]['_xmlrecursive']==json['_xmlrecursive']){found=true;}
delete childs[i]['_xmlrecursive'];}}
if(!found){childs.push(json);}}
if(found){node.appendChild(document.createTextNode('--recursive--'));}else{for(var x in json){if(json.hasOwnProperty(x)){if((x=='#text')){node.appendChild(document.createTextNode(json[x]));}else if(x=='@attributes'){for(var y in json[x]){if(json[x].hasOwnProperty(y)){node.setAttribute(y,json[x][y]);}}}else if(x=='#comment'){}else{if((json[x]instanceof Array)){for(var i=0;i<json[x].length;i++){node.appendChild(Fdl.json2xml(json[x][i],document.createElement((x=='link')?'_xmllink':x),childs));}}else{if(x){node.appendChild(Fdl.json2xml(json[x],document.createElement((x=='link')?'_xmllink':x),childs));}}}}}}}
if(root==true){return node.innerHTML.replace(/_xmllink/g,'link');}else{return node;}};Fdl.text2xml=function(strXML){var xmlDoc=null;try{xmlDoc=(document.all)?new ActiveXObject("Microsoft.XMLDOM"):new DOMParser();xmlDoc.async=false;}catch(e){throw new Error("XML Parser could not be instantiated");}
var out;try{if(document.all){out=(xmlDoc.loadXML(strXML))?xmlDoc:false;}else{out=xmlDoc.parseFromString(strXML,"text/xml");}}catch(e){throw new Error("Error parsing XML string");}
return out;};Fdl.xml2json=function(xml){var obj={};if(!xml)
return false;if(xml.nodeType==1){if(xml.attributes.length>0){obj['@attributes']={};for(var j=0;j<xml.attributes.length;j++){obj['@attributes'][xml.attributes[j].nodeName]=xml.attributes[j].nodeValue;}}}else if(xml.nodeType==3){obj=xml.nodeValue;}
if(xml.hasChildNodes()){if((!obj['@attributes'])&&(xml.childNodes.length==1)&&(xml.childNodes[0].nodeName=='#text')){obj=xml.childNodes[0].nodeValue;}else{for(var i=0;i<xml.childNodes.length;i++){if(typeof(obj[xml.childNodes[i].nodeName])=='undefined'){obj[xml.childNodes[i].nodeName]=Fdl.xml2json(xml.childNodes[i]);}else{if(typeof(obj[xml.childNodes[i].nodeName].length)=='undefined'){var old=obj[xml.childNodes[i].nodeName];obj[xml.childNodes[i].nodeName]=[];obj[xml.childNodes[i].nodeName].push(old);}
obj[xml.childNodes[i].nodeName].push(Fdl.xml2json(xml.childNodes[i]));}}}}
return obj;};Fdl.cloneObject=function(srcInstance){if(typeof(srcInstance)!='object'||srcInstance==null){return srcInstance;}
var newInstance=srcInstance.constructor();for(var i in srcInstance){newInstance[i]=Fdl.cloneObject(srcInstance[i]);}
return newInstance;};Fdl.encodeHtmlTags=function(v){if(v&&(typeof v=='string')){v=v.replace(/\&/g,'&amp;');v=v.replace(/\</g,'&lt;');v=v.replace(/\>/g,'&gt;');}else if(v&&(typeof v=='object')){for(var i=0;i<v.length;i++){if(v[i]&&(typeof v[i]=='string')){v[i]=v[i].replace(/\&/g,'&amp;');v[i]=v[i].replace(/\</g,'&lt;');v[i]=v[i].replace(/\>/g,'&gt;');}}}
return v;};Fdl.createDocument=function(config){if(config&&config.familyId){data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'create',id:config.familyId});if(data){if(!data.error){var nd;if(data.properties.defdoctype=='D')
nd=new Fdl.Collection({context:this.context});else
nd=new Fdl.Document({context:this.context});nd.affect(data);nd._mvalues.familyid=nd.getProperty('fromid');return nd;}else{this.context.setErrorMessage(data.error);}}
return false;}};Fdl.Context=function(config){if(!config)config={};if(config){if(!config.url)this.url='./';else this.url=config.url;if(this.url.substr(-4,4)=='.php'){throw"Wrong context url: ["+this.url+"], url must not end with .php";}else if(this.url.substr(-1,1)!='/')
this.url+='/';}};Fdl.Context.prototype={url:'',_isConnected:null,_isAuthenticated:null,_serverTime:null,_documents:new Object(),_fixDocuments:new Object(),notifier:null,lastErrorMessage:'',lastErrorCode:'',debug:false,propertiesInformation:null,catalog:null,autoLoadCatalog:true,locale:null,familyMap:null,getPropertiesInformation:function(){if(!this.propertiesInformation){this.getDocument({id:2,useCache:false,onlyValues:false,propertiesInformation:true});}
return this.propertiesInformation;}};Fdl.Context.prototype.toString=function(){return'Fdl.Context';};Fdl.Context.prototype.loadCatalog=function(locale){if(!locale)locale=this.locale;if(!locale){var u=this.getUser();if(u.locale){this.locale=u.locale.substr(0,u.locale.indexOf('_'));locale=this.locale;}else locale='fr';}
var url='locale/'+locale+'/js/catalog.js';console.log("load catalog"+url);var c=this.retrieveData('','',true,url);if(c){this.catalog=c;return true;}else this.catalog=false;return false;};Fdl.Context.prototype.getSortableProperties=function(){var f=[];var pi=this.getPropertiesInformation();for(var i in pi){if(pi[i].sortable)f.push(i);}
return f;};Fdl.Context.prototype.getPropertyInformation=function(id){var pis=this.getPropertiesInformation();if(pis){var pi=pis[id];if(pi)return pi;}
return null;};Fdl.Context.prototype.getDisplayableProperties=function(){var f=[];var pi=this.getPropertiesInformation();for(var i in pi){if(pi[i].displayable)f.push(i);}
return f;};Fdl.Context.prototype.getFilterableProperties=function(){var f=[];var pi=this.getPropertiesInformation();for(var i in pi){if(pi[i].filterable)f.push(i);}
return f;};Fdl.Context.prototype.connect=function(config){if(config){if(config.url){this.url=config.url;if(this.url.substr(-4,4)=='.php')
this.url+='?';else if(this.url.substr(-1,1)!='/')
this.url+='/';}}};Fdl.Context.prototype.isConnected=function(config){if(typeof config=='object'&&config.reset)this._isConnected=null;if(this._isConnected===null&&this.url){var lconfig={};var me=this;if(config&&config.onConnect&&config.onFail){lconfig.onComplete=function(){me._isConnected=true;if(me._connectTimeId){clearTimeout(me._connectTimeId);me._connectTimeId=0;}
config.onConnect();};lconfig.onError=function(x){if(me._isConnected===null){me._isConnected=false;if(me._connectTimeId){clearTimeout(me._connectTimeId);me._connectTimeId=0;}
config.onFail();}};if(config.timeout>0){me._connectTimeId=setTimeout(function(){if(me._isConnected===null){me._isConnected=false;me._connectTimeId=0;config.onFail();}},config.timeout);}}
var data=this.retrieveData({app:'DATA',action:'USER',method:'ping'},lconfig,false);this._serverTime=null;if(data){if(data.error){if(data.error=="not authenticated"){this._isConnected=true;}else{this.setErrorMessage(data.error);this._isConnected=false;}}else{this._isConnected=true;this._serverTime=data.time;}}}
return this._isConnected;};Fdl.Context.prototype.isAuthenticated=function(config){if(config&&config.reset)this._isAuthenticated=null;if(this._isAuthenticated===null){var userdata=this.retrieveData({app:'DATA',action:'USER'});if(userdata){if(userdata.error){this.setErrorMessage(userdata.error);this._isAuthenticated=false;}else{if(!this.user)
this.user=new Fdl.User({data:userdata,context:this});if(this.autoLoadCatalog)this.loadCatalog();this._isAuthenticated=true;}}}
return this._isAuthenticated;};Fdl.Context.prototype.setAuthentification=function(config){if(config){if(!config.login){this.setErrorMessage(this._("data::login not defined"));return null;}
if(!config.password){this.setErrorMessage(this._("data::password not defined"));return null;}
var userdata=this.retrieveData({app:'DATA',action:'USER',method:'authent'},config,false);if(userdata.error){this._isAuthenticated=false;this.setErrorMessage(userdata.error);return null;}else{this._isAuthenticated=true;this.user=new Fdl.User({data:userdata,context:this});if(this.user.locale)this.locale=this.user.locale.substr(0,this.user.locale.indexOf('_'));return this.user;}}};Fdl.Context.prototype.setErrorMessage=function(msg,code){if(msg){this.lastErrorMessage=msg;if(code)this.lastErrorCode=code;}};Fdl.Context.prototype.getLastErrorMessage=function(){return this.lastErrorMessage;};Fdl.Context.prototype.getText=function(s){return this._(s);};Fdl.Context.prototype._=function(s){if((this.catalog===null)&&(this.autoLoadCatalog))this.loadCatalog();if(this.catalog&&s&&this.catalog[s])return this.catalog[s];return s;};Fdl.Context.prototype.getUser=function(config){if(config){if(config.reset)
this.user=null;}
if(!this.user){this.user=new Fdl.User({context:this});if(this.user.locale)this.locale=this.user.locale.substr(0,this.user.locale.indexOf('_'));}
return this.user;};Fdl.Context.prototype.resizeImage=function(icon,width){var u=this.url;var src=this.url+icon;var ps=u.lastIndexOf('/');if(ps){u=u.substring(0,ps+1);src=u+icon;}
src=u+'resizeimg.php?size='+width+'&img='+escape(src);return src;};Fdl.Context.prototype.retrieveData=function(urldata,parameters,anonymousmode,otherroot){var URIElements=[];var xreq=null;var encodeElementForSend=function(key,value){return encodeURIComponent(key)+'='+encodeURIComponent(value);};if(typeof window!='undefined'){if(window.XMLHttpRequest){xreq=new XMLHttpRequest();}else if(window.ActiveXObject){xreq=new ActiveXObject("Microsoft.XMLHTTP");}}else{xreq=Components.classes["@mozilla.org/xmlextras/xmlhttprequest;1"].createInstance(Components.interfaces.nsIXMLHttpRequest);}
var sync=true;if(xreq){if(parameters&&parameters.onComplete){sync=false;xreq.onreadystatechange=function(){if(xreq.readyState==4){if(xreq.status==200){parameters.onComplete(xreq);}else{if(parameters.onError){parameters.onError(xreq);}}}};}
var url=this.url;if(!url)
url='/';if(otherroot)
url+=otherroot;else if(anonymousmode)
url+='guest.php';else
url+='data.php';var method="POST";if((!urldata)&&(!parameters)&&otherroot){method="GET";}
xreq.open(method,url,(!sync));if(method){var name=null;xreq.setRequestHeader("Content-Type","application/x-www-form-urlencoded");for(name in urldata){URIElements.push(encodeElementForSend(name,urldata[name]));}
if(parameters){for(name in parameters){if(name!='context'){if(typeof parameters[name]=='object'){try{URIElements.push(encodeElementForSend(name,JSON.stringify(parameters[name])));}catch(e){URIElements.push(encodeElementForSend(name,parameters[name]));}}else{URIElements.push(encodeElementForSend(name,parameters[name]));}}}}}
try{if(URIElements.length===0)
xreq.send('');else
xreq.send(URIElements.join("&"));}catch(exception){this.setErrorMessage('HTTP status: unable to send request');}
if(sync){if(xreq.status==200){var r=false;try{var db1=new Date().getTime();if(parameters&&parameters.plainfile){r=xreq.responseText;}else{r=JSON.parse(xreq.responseText);if(this.debug)r["evalDebugTime"]=(new Date().getTime())-db1;if(r.error)this.setErrorMessage(r.error);if(r.log){console.log('datalog:',r.log);delete r.log;}
if(r.spentTime)
console.log({time:r.spentTime});delete r.spentTime;}}catch(ex){alert('error on serveur data:'+xreq.responseText);}
return r;}else{if(xreq)
this.setErrorMessage('HTTP status:'+xreq.status);}}}
return false;};Fdl.Context.prototype.retrieveFile=function(filepath,parameters){return this.retrieveData(parameters,{plainfile:true},false,filepath);};Fdl.Context.prototype.sendForm=function(urldata,target,otherroot){var url=this.url;if(!url)url='/';if(otherroot)url+=otherroot;else url+='data.php';var form=document.getElementById('fdlsendform');if(form)document.body.removeChild(form);form=document.createElement('form');form.setAttribute('action',url);form.setAttribute('enctype','multipart/form-data');form.setAttribute('id','fdlsendform');if(target=='_hidden')form.setAttribute('target',Fdl.getHiddenTarget());else form.setAttribute('target',target);form.setAttribute('method','POST');form.style.display='none';document.body.appendChild(form);for(var name in urldata){var newElement=document.createElement("input");newElement.setAttribute('type','hidden');newElement.setAttribute('name',name);form.appendChild(newElement);if(typeof urldata[name]=='object'){try{newElement.value=JSON.stringify(urldata[name]);}catch(e){newElement.value=urldata[name];}}else newElement.value=urldata[name];}
form.submit();return true;};Fdl.Context.prototype.addFamilyMap=function(config){if(config.familyName&&config.className){if(this.familyMap==null)this.familyMap={};this.familyMap[config.familyName]=config.className;}
return true;};Fdl.Context.prototype.stringToFunction=function(str){var fn=eval(str);if(typeof fn!=="function"){throw new Error("function not found");}
return fn;};Fdl.Context.prototype.getDocument=function(config){if(config)
config.context=this;else
config={context:this};var docid=config.id;var latest=true;if(typeof config=='object'&&config.latest===false)latest=false;if(docid&&(typeof docid=='object')&&(docid.length==1)){docid=docid[0];config.id=docid;}
if(typeof docid=='object'){this.setErrorMessage(this._("data:document id must not be an object"));return null;}
if((!docid)&&config.data&&config.data.properties){docid=config.data.properties.id;}
if(config.data&&config.data.properties&&config.data.properties.id&&docid){if(latest){if(this._documents[docid]&&this._documents[docid]._data&&(config.data.requestDate<=this._documents[docid]._data.requestDate)){return this._documents[docid];}}else{if(this._fixDocuments[docid]&&this._fixDocuments[docid]._data){return this._fixDocuments[docid];}}}else if(docid){if(config.useCache&&this._documents[docid]){return this._documents[docid];}}
if(!docid){this.setErrorMessage(this._("data:document id not set"));return null;}
var wdoc=new Fdl.Document(config);if(!wdoc._data)return null;if(this.familyMap!=null&&this.familyMap[wdoc.getProperty('fromname')]){var sname=wdoc.getProperty('fromname');config.data=wdoc._data;var sclass=this.stringToFunction(this.familyMap[sname]);wdoc=new sclass(config);}else if((wdoc.getProperty('defdoctype')=='D')||(wdoc.getProperty('defdoctype')=='S')){config.data=wdoc._data;wdoc=new Fdl.Collection(config);}else if(wdoc.getProperty('doctype')=='C'){config.data=wdoc._data;wdoc=new Fdl.Family(config);}else if(wdoc.getProperty('doctype')=='W'){config.data=wdoc._data;wdoc=new Fdl.Workflow(config);}
if(config&&(!config.noCache)&&(!wdoc.partialDocument)){if(latest){this._documents[wdoc.getProperty('initid')]=wdoc;if(wdoc.getProperty('id')!=wdoc.getProperty('initid')){this._documents[wdoc.getProperty('id')]=wdoc;}
if((docid!=wdoc.getProperty('id'))&&(docid!=wdoc.getProperty('initid'))){this._documents[docid]=wdoc;}}else{this._fixDocuments[wdoc.getProperty('id')]=wdoc;}}
return wdoc;};Fdl.Context.prototype.getNotifier=function(config){if(config){if(config.reset)
this.notifier=null;}
if(!this.notifier){if(config)
config.context=this;else
config={context:this};this.notifier=new Fdl.Notifier(config);}
return this.notifier;};Fdl.Context.prototype.getSearchDocument=function(config){if(config)
config.context=this;else
config={context:this};return new Fdl.SearchDocument(config);};Fdl.Context.prototype.getSearchCriteria=function(){if(this._opcriteria)return this._opcriteria;var r=this.retrieveData({app:'DATA',action:'DOCUMENT',method:'getsearchcriteria'});if(!r.error){this._opcriteria=r.operators;return this._opcriteria;}
return null;};Fdl.Context.prototype.createGroupRequest=function(config){if(config)
config.context=this;else
config={context:this};return new Fdl.GroupRequest(config);};Fdl.Context.prototype.getHomeFolder=function(config){if(this._homeFolder)
return this._homeFolder;var u=this.getUser();if((u!=null)&&u.id){var idhome='FLDHOME_'+u.id;if(!config)config={};config.id=idhome;var h=this.getDocument(config);if(h!=null&&h.isAlive()){this._homeFolder=h;return h;}}
return null;};Fdl.Context.prototype.getDesktopFolder=function(config){if(this._desktopFolder)
return this._desktopFolder;var u=this.getUser();if((u!=null)&&u.id){var idhome='FLDDESKTOP_'+u.id;if(!config)config={};config.id=idhome;var h=this.getDocument(config);if(h!=null&&h.isAlive()){this._desktopFolder=h;return h;}}
return null;};Fdl.Context.prototype.getOfflineFolder=function(config){if(this._offlineFolder)
return this._offlineFolder;var u=this.getUser();if((u!=null)&&u.id){var idhome='FLDOFFLINE_'+u.id;if(!config)config={};config.id=idhome;var h=this.getDocument(config);if(h!=null&&h.isAlive()){this._offlineFolder=h;return h;}}
return null;};Fdl.Context.prototype.getBasketFolder=function(config){if(this._basketFolder)
return this._basketFolder;var u=this.getUser();if((u!=null)&&u.id){var idhome='FLDHOME_'+u.id;if(!config)config={};config.id=idhome;var h=this.getDocument(config);if(h!=null&&h.isAlive()){this._basketFolder=h;return h;}else{var f=new Fdl.DocumentFilter({family:'DIR strict',criteria:[{operator:'=',left:'owner',right:'-'+u.id}]});var s=this.context.getSearchDocument({filter:f});var dl=s.search();if(dl&&(dl.count>0)){var p=dl.getDocuments();this._basketFolder=p[0];return this._basketFolder;}}}
return null;};Fdl.Context.prototype.createDocument=function(config){if(config&&(config.family||config.familyId)){var data=this.retrieveData({app:'DATA',action:'DOCUMENT',method:'create',id:(config.family)?config.family:config.familyId,temporary:config.temporary});if(data){if(!data.error){var nd;if((data.properties.defdoctype=='D')||(data.properties.defdoctype=='S'))
nd=new Fdl.Collection({context:this});else
nd=new Fdl.Document({context:this});nd.affect(data);nd._mvalues.family=nd.getProperty('fromid');return nd;}else{this.setErrorMessage(data.error);}}
return null;}};Fdl.Context.prototype.getApplication=function(config){if(config)config.context=this;else config={context:this};var a=new Fdl.Application(config);if(!a.id)return null;return a;};Fdl.Context.prototype.getParameter=function(config){if(config){if(config.id){if(!this.application)this.application=new Fdl.Application({context:this,name:'CORE'});return this.application.getParameter(config);}}};Fdl.Context.prototype.setParameter=function(config){if(config){if(config.id){if(!this.application)this.application=new Fdl.Application({context:this,name:'CORE'});return this.application.setParameter(config);}}};Fdl.Notifier=function(config){if(config){this.context=config.context;}};Fdl.Notifier.prototype={lastRetrieveTime:null,nextDelay:30,context:null,subscribeItems:[]};Fdl.Notifier.prototype.toString=function(){return'Fdl.Notifier';};Fdl.Notifier.prototype.subscribe=function(obj){var sobj=obj;var scall='fireEvent';if(obj&&obj.object){sobj=obj.object;if(!obj.callback){if(obj.object.fireEvent)obj.callback='fireEvent';else return false;}else{scall=obj.callback;}
for(var i=0;i<this.subscribeItems.length;i++){if(this.subscribeItems[i].object==obj.object)return false;}
this.subscribeItems.push({object:sobj,callback:scall});return true;}
return null;};Fdl.Notifier.prototype.unsubscribe=function(sobj){if(sobj){for(var i=0;i<this.subscribeItems.length;i++){if(this.subscribeItems[i].object==sobj){if(this.subscribeItems.length==1){this.subscribeItems=[];}else{if(i<(this.subscribeItems.length-1))this.subscribeItems[i]=this.subscribeItems[this.subscribeItems.length-1];this.subscribeItems.pop();}
return true;}}}
return false;};Fdl.Notifier.prototype.retreive=function(config){if(this.context){var r=this.context.retrieveData({date:this.lastRetrieveTime},null,false,'notifier.php');if(r.error){this.context.setErrorMessage(r.error);return null;}else{if(r.date)this.lastRetrieveTime=r.date;if(r.delay)this.nextDelay=r.delay;if(r.notifications)return r.notifications;}}
return[];};Fdl.Notifier.prototype.loop=function(config){if(this.context){if((!this.activated)||(config&&config.auto)){var r=this.retreive();if(r&&r.length){for(var i=0;i<r.length;i++){for(var j=0;j<this.subscribeItems.length;j++){try{this.subscribeItems[j].object[this.subscribeItems[j].callback](r[i].code,r[i]);}catch(exception){}}}}
var me=this;this.activated=true;window.setTimeout(function(){me.loop({auto:true});},this.nextDelay*1000);return true;}}
return false;};Fdl.Notifier.Notification=function(config){};Fdl.Notifier.Notification.prototype={code:null,arg:null,date:null,id:null,initid:null,title:null,level:null,uid:null,uname:null};Fdl.Document=function(config){if(config){var data=null;if(config.context){this.context=config.context;}
if(!config.data){this.id=config.id;this.latest=(config.latest==null)?false:config.latest;this.revision=(this.latest==true)?null:config.revision;this._data=null;if(this.id)data=this.context.retrieveData({app:'DATA',action:'DOCUMENT'},config);}else data=config.data;if(data)this.affect(data);else return false;}};Fdl.Document.prototype={id:null,latest:null,revision:null,context:Fdl,followingStates:null,requestDate:'',_mvalues:new Object(),_attributes:null,affect:function(data){if(data&&(typeof data=='object')){if(!data.error){this._mvalues=new Object();this._data=data;if(data.properties){this.id=data.properties.id;if(data.properties.informations)this.context.propertiesInformation=data.properties.informations;if(data.attributes)this.completeAttributes(data.attributes);if(data.followingStates)this.followingStates=data.followingStates;if(data.userTags)this.userTags=data.userTags;if(data.requestDate)this.requestDate=data.requestDate;return true;}else{alert('error no properties');}}else{this.context.setErrorMessage(data.error);return false;}}
return false;},toString:function(){return'Fdl.Document';},getTitle:function(otherid){if(!this._data)return null;if(otherid){return"search "+otherid;}else{return this._data.properties.title;}},getIcon:function(config){if(!this._data)return null;var width=false;var src=this.context.url+this._data.properties.icon;if(config&&config.width){width=config.width;var u=this.context.url;var ps=u.lastIndexOf('/');if(ps){u=u.substring(0,ps+1);src=u+this._data.properties.icon;}
src=u+'resizeimg.php?size='+width+'&img='+escape(src);}
return src;},getState:function(){return this._data.properties.state;},getLocalisedState:function(){return this._data.properties.labelstate;},getColorState:function(){return this._data.properties.colorstate;},getActivityState:function(){return this._data.properties.activitystate;},getValue:function(id,def){var v=this._data.values[id];if(v===undefined&&def===undefined){var oa=this.getAttribute(id);if(oa)return null;else return undefined;}
return((v==null)?def:v);},getArrayValues:function(id){var oa=this.getAttribute(id);var rv=[];if(oa){var oas=oa.getElements();var vc;if(oas.length>0&&this.getValue(oas[0].id).length>0){var i=0;for(i=0;i<this.getValue(oas[0].id).length;i++){rv[i]=new Object();}
for(i=0;i<oas.length;i++){vc=this.getValue(oas[i].id);for(var ic=0;ic<vc.length;ic++){rv[ic][oas[i].id]=vc[ic];}}}}
return rv;},getDisplayValue:function(id,config){var oa=this.getAttribute(id);var i=0,vs=null,tv=[];if(oa){if(!this._data.values[id])return this._data.values[id];if(oa.toString()=='Fdl.RelationAttribute')return Fdl.encodeHtmlTags(this.getValue(id+'_title',this._data.values[id]));if(oa.toString()=='Fdl.ThesaurusAttribute')return Fdl.encodeHtmlTags(this.getValue(id+'_title',this._data.values[id]));if(oa.toString()=='Fdl.EnumAttribute'){if(oa.inArray()||oa.isMultiple()){tv=[];vs=this._data.values[id];if(vs){for(i=0;i<vs.length;i++){tv.push(oa.getEnumLabel({key:vs[i]}));}}
return tv;}else{return oa.getEnumLabel({key:this._data.values[id]});}}
if(oa.toString()=='Fdl.FileAttribute'){if(oa.inArray()){tv=[];vs=this._data.values[id];if(vs){for(i=0;i<vs.length;i++){if(config&&config.url){if(config.dav){tv.push(oa.getDavUrl(vs[i],this.id));}else{config.index=i;tv.push(oa.getUrl(vs,this.id,config));}}else tv.push(Fdl.encodeHtmlTags(oa.getFileName(vs[i])));}}
return tv;}else{if(config&&config.url){if(config.dav)return oa.getDavUrl(this._data.values[id],this.id);else return oa.getUrl(this._data.values[id],this.id,config);}else return Fdl.encodeHtmlTags(oa.getFileName(this._data.values[id]));}}
if(oa.toString()=='Fdl.DateAttribute'){var fmt=this.context.getUser().getLocaleFormat();var dateFmt='';if(oa.type=='date'){dateFmt=fmt.dateFormat;}else if(oa.type=='timestamp'){dateFmt=fmt.dateTimeFormat;}else if(oa.type=='time'){dateFmt=fmt.timeFormat;}
if(dateFmt){if(oa.inArray()){vs=this._data.values[id];tv=[];for(i=0;i<vs.length;i++){tv.push(Fdl.formatDate(vs[i],dateFmt));}
return tv;}else{return Fdl.formatDate(this._data.values[id],dateFmt);}}}}
return Fdl.encodeHtmlTags(this._data.values[id]);},setValue:function(id,value){var oa=this.getAttribute(id);if(!oa){this.context.setErrorMessage('setValue: attribute '+id+' not exist');return null;}
if(this.getProperty('locked')==-1){this.context.setErrorMessage(this.context._("setValue: document is fixed"));return null;}
if(value!=this._data.values[oa.id]){this._data.values[oa.id]=value;this._mvalues[oa.id]=value;}
return true;},setLogicalName:function(name){this._data.properties['name']=name;this._mvalues['name']=name;return true;},setLogicalIdentificator:function(name){this._data.properties['name']=name;this._mvalues['name']=name;return true;},hasChanged:function(){if(typeof this._mvalues==='object'){for(i in this._mvalues){v=this._mvalues[i];if(v!==undefined&&typeof v!=='function'){return true;}}}
return false;},getProperty:function(id){if(!this._data)return null;return this._data.properties[id];},getProperties:function(id){if(!this._data)return null;return this._data.properties;},getValues:function(){if(!this._data)return null;return this._data.values;},getAttribute:function(id){if(!this._attributes)this.getFamilyAttributes();if(!this._attributes)return null;if(typeof this._attributes=='object'&&this._attributes[id])return this._attributes[id];return null;},getAttributes:function(){if(!this._attributes){return this.getFamilyAttributes();}
return this._attributes;},getFamilyAttributes:function(){if(!this._attributes){var f=this.context.getDocument({id:(this.getProperty('doctype')=='C'?this.getProperty('id'):this.getProperty('fromid')),useCache:true,onlyValues:false,propertiesInformation:(this.context.propertiesInformation==null)});if(f&&f._attributes)this._attributes=f._attributes;else if(f&&(!f._attributes)){f=this.context.getDocument({id:(this.getProperty('doctype')=='C'?this.getProperty('id'):this.getProperty('fromid')),useCache:false,onlyValues:false,propertiesInformation:(this.context.propertiesInformation==null)});if(f&&f._attributes)this._attributes=f._attributes;}else{this._attributes=[];}}
return this._attributes;},getSortableAttributes:function(){var s=[];if(!this._attributes)this.getFamilyAttributes();if(this._attributes){for(var i in this._attributes){if(this._attributes[i].isSortable())
s.push(this._attributes[i]);}}
return s;},getFilterableAttributes:function(){var s=[];if(!this._attributes)this.getFamilyAttributes();if(this._attributes){for(var i in this._attributes){if(this._attributes[i].isLeaf()&&(this._attributes[i].type!='htmltext')&&(this._attributes[i].type!='color'))
s.push(this._attributes[i]);}}
return s;},isAlive:function(){return this._data&&this._data.properties&&(this._data.properties.id>0)&&(this._data.properties.doctype!='Z');},canEdit:function(){return(this.getProperty('readonly')==false);},hasWorkflow:function(){return(this.getProperty('wid')>0);},isDeleted:function(){return(this.getProperty('doctype')=='Z');},isFixed:function(){return(this.getProperty('locked')==-1);},isCollection:function(){var dt=this.getProperty('defdoctype');return((dt=='S')||(dt=='D'));}};Fdl.Document.prototype.completeAttributes=function(attrs){if(attrs){this._attributes=new Object();for(var name in attrs){switch(attrs[name].type){case'text':case'longtext':case'htmltext':this._attributes[attrs[name].id]=new Fdl.TextAttribute(attrs[name]);break;case'int':case'double':case'float':case'money':this._attributes[attrs[name].id]=new Fdl.NumericAttribute(attrs[name]);break;case'date':case'time':case'timestamp':this._attributes[attrs[name].id]=new Fdl.DateAttribute(attrs[name]);break;case'account':case'docid':this._attributes[attrs[name].id]=new Fdl.RelationAttribute(attrs[name]);break;case'color':this._attributes[attrs[name].id]=new Fdl.ColorAttribute(attrs[name]);break;case'enum':this._attributes[attrs[name].id]=new Fdl.EnumAttribute(attrs[name]);break;case'thesaurus':this._attributes[attrs[name].id]=new Fdl.ThesaurusAttribute(attrs[name]);break;case'file':case'image':this._attributes[attrs[name].id]=new Fdl.FileAttribute(attrs[name]);break;case'tab':this._attributes[attrs[name].id]=new Fdl.TabAttribute(attrs[name]);break;case'frame':this._attributes[attrs[name].id]=new Fdl.FrameAttribute(attrs[name]);break;case'array':this._attributes[attrs[name].id]=new Fdl.ArrayAttribute(attrs[name]);break;case'menu':case'action':this._attributes[attrs[name].id]=new Fdl.MenuAttribute(attrs[name]);break;default:this._attributes[attrs[name].id]=new Fdl.Attribute(attrs[name]);}
this._attributes[attrs[name].id]._family=this;}}};Fdl.Document.prototype.toJSON=function(key){return JSON.parse(JSON.stringify(this._data));};Fdl.Document.prototype.send=function(config){var result=this.context.retrieveData({app:'DATA',action:'DOCUMENT',id:this.id,method:'send'},config);if(result){return true;}else{this.context.setErrorMessage('send : no result');return false;}};Fdl.Document.prototype.save=function(config){if(this.getProperty('locked')==-1){this.context.setErrorMessage(this.context._("save : document is fixed"));return false;}
if(config&&config.form){return this.savefromform(config);}else{var autounlock=false;if(config&&config.autounlock)autounlock=true;if(!this.hasChanged())return true;var newdata=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'save',temporary:this.getProperty('doctype')=='T',id:this.id,autounlock:autounlock},this._mvalues);if(newdata){if(!newdata.error){this.affect(newdata);return true;}else{this.context.setErrorMessage(newdata.error);}}else{this.context.setErrorMessage('save : no data');}
return false;}};Fdl.Document.prototype.savefromform=function(config){if(config&&config.form!==null){if(config.form.nodeName!='FORM'&&config.form.nodeName!='html:form'){this.context.setErrorMessage('not a form object');return false;}
var f=config.form;var oriaction=f.action;var oritarget=f.target;var t=null;if(oritarget)t=document.getElementById(f.target);if(t&&t.contentDocument.body.firstChild){t.contentDocument.body.innerHTML='';}
var callid=Fdl._waitSave(this,config);f.action=this.context.url+'?app=DATA&action=DOCUMENT&method=saveform&id='+this.id+'&callid='+callid;if(config.autounlock)f.action+='&autounlock=true';f.target=Fdl.getHiddenTarget();f.submit();if(t&&t.contentDocument.body.firstChild){try{var v=eval('('+t.contentDocument.body.innerHTML+')');}catch(ex){}}
f.action=oriaction;f.target=oritarget;return true;}
return false;};Fdl.Document.prototype.reload=function(config){if(this.hasChanged()){this.context.setErrorMessage('reload : cannot reload because data are locally modified');}else{if(!config)config=new Object();config.method='reload';return this.callMethod(config);}
return false;};Fdl.Document.prototype.changeState=function(config){if(!config)config=new Object();config.method='changestate';return this.callMethod(config);};Fdl.Document.prototype.addUserTag=function(config){if(!config)config=new Object();config.method='addusertag';if(!config.tag){this.context.setErrorMessage(this.context._("data::no tag specified"));return null;}
return this.callMethod(config);};Fdl.Document.prototype.deleteUserTag=function(config){if(!config)config=new Object();config.method='deleteusertag';if(!config.tag){this.context.setErrorMessage(this.context._("data::no tag specified"));return null;}
return this.callMethod(config);};Fdl.Document.prototype.getUserTags=function(config){if(!config)config=new Object();config.method='getusertags';if(this.userTags&&(!config.reset))return this.userTags;var r=this.callMethod(config);if(!r.error){this.userTags=r.userTags;return r.userTags;}
return null;};Fdl.Document.prototype.allocate=function(config){if(!config)config=new Object();config.method='allocate';return this.callMethod(config);};Fdl.Document.prototype.unallocate=function(config){if(!config)config=new Object();config.method='unallocate';return this.callMethod(config);};Fdl.Document.prototype.remove=function(config){if(this.hasChanged()){this.context.setErrorMessage('remove : cannot remove because data are locally modified');}else{if(!config)config=new Object();config.method='delete';return this.callMethod(config);}
return false;};Fdl.Document.prototype.restore=function(config){if(this.hasChanged()){this.context.setErrorMessage('restore : cannot restore because data are locally modified');}else{if(!config)config=new Object();config.method='restore';return this.callMethod(config);}
return false;};Fdl.Document.prototype.lock=function(config){if(!config)config=new Object();config.method='lock';return this.callMethod(config);};Fdl.Document.prototype.unlock=function(config){if(!config)config=new Object();config.method='unlock';return this.callMethod(config);};Fdl.Document.prototype.hasWaitingFiles=function(){var data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'haswaitingfiles',id:this.id});if(data){if(!data.error){return data.haswaitingfiles;}else{this.context.setErrorMessage(data.error);}}else{this.context.setErrorMessage('hasWaitingFiles : no data');}
return false;};Fdl.Document.prototype.getFollowingStates=function(){if(!this.id)return null;if(this.followingStates)return this.followingStates;else{var data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'getfollowingstates',id:this.id});if(data){if(!data.error){this.followingStates=data.followingStates;return data.followingStates;}else{this.context.setErrorMessage(data.error);}}else{this.context.setErrorMessage('getFollowingStates : no data');}}
return false;};Fdl.Document.prototype.getHistory=function(){this.history=new Fdl.DocumentHistory({id:this.id,context:this.context});if(this.history.items==null)return null;return this.history;};Fdl.Document.prototype.addRevision=function(config){if(!config)config=new Object();config.method='addrevision';return this.callMethod(config);};Fdl.Document.prototype.callMethod=function(config){if(config&&config.method){var data=null;if(config.norequest){data=this._data;}else{data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:config.method,id:this.id},config);}
if(data){if(!data.error){if(!config.norequest){if(data.properties)this.affect(data);else return data;}
return true;}else{this.context.setErrorMessage(data.error);}}else{this.context.setErrorMessage(config.method+' : no data');}}
return false;};Fdl.Document.prototype.cloneDocument=function(config){var data=null;if(config&&config.norequest){data=this._data;}else{data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'clone',id:this.id},config);}
if(data){if(!data.error){var clone=eval('new '+this.toString()+'()');clone.context=this.context;clone.affect(data);return clone;}else{this.context.setErrorMessage(data.error);}}else{this.context.setErrorMessage(config.method+' : no data');}
return null;};Fdl.Document.prototype.moveTo=function(config){if(config&&config.folderId){if(!config)config=new Object();config.method='moveto';return this.callMethod(config);}
return false;};Fdl.Document.prototype.getViews=function(){if(!this._data){this.context.setErrorMessage('getviews : no data');return null;}else if(this._data.configuration&&this._data.configuration.views){return this._data.configuration.views;}
return false;};Fdl.Document.prototype.getDefaultConsultationView=function(){var vs=this.getViews();if(vs){for(v in vs){if((vs[v]['default']=="yes")&&(vs[v].kind=="consultation"))return vs[v];}}
return false;};Fdl.Document.prototype.getDefaultEditionView=function(){var vs=this.getViews();if(vs){for(v in vs){if((vs[v]['default']=="yes")&&(vs[v].kind=="edition"))return vs[v];}}
return false;};Fdl.Document.prototype.getAttachedTimers=function(config){if(!this.id)return null;if(this.attachedTimers&&((!config)||(config&&(!config.reset))))return this.attachedTimers;else{var data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'getAttachedTimers',id:this.id});if(data){if(!data.error){this.attachedTimers=data.attachedTimers;return data.attachedTimers;}else{this.context.setErrorMessage(data.error);}}else{this.context.setErrorMessage('getAttachedTimers : no data');}}
return false;};Fdl.Document.prototype.control=function(acl){if(!this.id)return null;if(!this._data.security)return null;if(!acl)return null;if(acl.acl)acl=acl.acl;if(this._data.security[acl]){return this._data.security[acl].control;}
return null;};Fdl.Document.prototype.getProfilAcls=function(){if(!this.id)return null;if(this._data.security)return this._data.security;return false;};Fdl.Document.prototype.getFilterableProperties=function(){f=[];if(this.context){return this.context.getFilterableProperties();}
return f;};Fdl.Document.prototype.getDisplayableProperties=function(){f=[];if(this.context){return this.context.getDisplayableProperties();}
return f;};Fdl.Document.prototype.getSortableProperties=function(){f=[];if(this.context){return this.context.getSortableProperties();}
return f;};Fdl.Document.prototype.getPropertyInformation=function(id){if(this.context){return this.context.getPropertyInformation(id);}
return null;};Fdl.Document.prototype.getSearchCriteria=function(){if(this.context)return this.context.getSearchCriteria();return null;};Fdl.Document.prototype.getHighlight=function(){return this._data.highlight;};Fdl.DocumentList=function(config){this.content=[];if(config){for(var i in config)
this[i]=config[i];}
if(this.content)this.length=this.content.length;};Fdl.DocumentList.prototype={totalCount:0,content:null,info:null,length:0,context:null,getDocuments:function(){var out=[];for(var i=0;i<this.content.length;i++){if(typeof this.content[i]=='object'){out.push(this.context.getDocument({data:this.content[i]}));}else
alert('FdlDocuments: error in returned');}
return out;},getDocument:function(index){if(typeof this.content[index]=='object'){return(this.context.getDocument({data:this.content[index]}));}
return null;},count:function(){return this.totalCount;},toString:function(){return'Fdl.DocumentList';}};Fdl.Collection=function(config){Fdl.Document.call(this,config);};Fdl.Collection.prototype=new Fdl.Document();Fdl.Collection.prototype.toString=function(){return'Fdl.Collection';};Fdl.Collection.prototype.getContent=function(config){if(!this.getProperty('initid')){this.context.setErrorMessage('getContent: no identifier set');return null;}
var data=null;if(config&&config.data){data=config.data;}else{if(config&&config.filter)config.filter=JSON.stringify(config.filter);data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'getcontent',id:this.getProperty('initid')},config);}
if(data){if(!data.error){data.context=this.context;return new Fdl.DocumentList(data);}else{this.context.setErrorMessage(data.error);}}else return null;};Fdl.Collection.prototype.getStoredContent=function(){if(this._data.storedContent){return this.getContent({data:this._data.storedContent});}
return null;};Fdl.Collection.prototype.getSubCollections=function(){return this.getContent({verifyhaschild:true,filter:"doctype = 'D' or doctype = 'S'"});};Fdl.Collection.prototype.getSubFolders=function(){return this.getContent({verifyhaschild:true,filter:"doctype = 'D'"});};Fdl.Collection.prototype.insertDocument=function(config){if(config&&config.id){var data=null;if(config.norequest){data=this._data;}else{data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'insertdocument',id:this.getProperty('initid'),idtoadd:config.id});}
if(!data.error){return true;}else{this.context.setErrorMessage(data.error);}}
return false;};Fdl.Collection.prototype.unlinkDocument=function(config){if(config&&config.id){var data=null;if(config.norequest){data=this._data;}else{data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'unlinkdocument',id:this.getProperty('initid'),idtounlink:config.id});}
if(!data.error){return true;}else{this.context.setErrorMessage(data.error);}}
return false;};Fdl.Collection.prototype.insertDocuments=function(config){if(config&&config.selection){var data=null;if(config.norequest){data=this._data;}else{console.log('insert',config);if(config.selection)config.selection=JSON.stringify(config.selection);data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'insertdocuments',id:this.getProperty('initid')},config);}
if(!data.error){return data;}else{this.context.setErrorMessage(data.error);}}
return false;};Fdl.Collection.prototype.moveDocuments=function(config){if(config&&config.selection){var data=null;if(config.norequest){data=this._data;}else{if(config.selection)config.selection=JSON.stringify(config.selection);data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'movedocuments',id:this.getProperty('initid')},config);}
if(!data.error){return data;}else{this.context.setErrorMessage(data.error);}}
return false;};Fdl.Collection.prototype.unlinkDocuments=function(config){if(config&&config.selection){var data=null;if(config.norequest){data=this._data;}else{if(config.selection)config.selection=JSON.stringify(config.selection);data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'unlinkdocuments',id:this.getProperty('initid')},config);}
if(!data.error){return data;}else{this.context.setErrorMessage(data.error);}}
return false;};Fdl.Collection.prototype.unlinkAllDocuments=function(config){var data=null;if(config&&config.norequest){data=this._data;}else{data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'unlinkalldocuments',id:this.getProperty('initid')},config);}
if(!data.error){return true;}else{this.context.setErrorMessage(data.error);}
return false;};Fdl.Collection.prototype.getAuthorizedFamilies=function(config){if(this.id){if(this.authorizedFamilies&&((!config)||(config&&(!config.reset))))return this.authorizedFamilies;var data=null;if(config&&config.data){data=config.data;}else{data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'getAuthorizedFamilies',id:this.getProperty('initid')});}
if(!data.error){this.authorizedFamilies=new Object();if(data.authorizedFamilies.restriction){this.authorizedFamilies.families=new Object();for(var i in data.authorizedFamilies.families){this.authorizedFamilies.families[i]={id:i,title:data.authorizedFamilies.families[i]['title']};}}else{this.authorizedFamilies.families=null;}
this.authorizedFamilies.restriction=data.authorizedFamilies.restriction;return this.authorizedFamilies;}else{this.context.setErrorMessage(data.error);}}
return false;};Fdl.Collection.prototype.hasRestriction=function(config){if(this.id){var authfam=this.getAuthorizedFamilies(config);if(authfam)return authfam.restriction;}
return false;};Fdl.Collection.prototype.isFolder=function(){return(this.getProperty('defdoctype')=="D");};Fdl.Collection.prototype.isSearch=function(){return(this.getProperty('defdoctype')=="S");};Fdl.Collection.prototype.addFilter=function(filter){if(!this.isSearch())return false;if(!filter)return false;if(filter.family){var st=filter.family.indexOf('strict');if(st){st=filter.family.indexOf(' ');this.setValue("se_famid",filter.family.substr(0,st));this.setValue("se_famonly","yes");}else{this.setValue("se_famid",filter.family);}}
if(filter.criteria||filter.sql||filter.family){var fs=this.getValue("se_filter");var fsType=this.getValue("se_typefilter");var newfs=[];var newfsType=[];if(fs)newfs=newfs.concat(fs);if(fsType)newfsType=newfsType.concat(fsType);newfs.push(Fdl.json2xml({filter:filter.normalize()}));newfsType.push('specified');this.setValue("se_filter",newfs);this.setValue("se_typefilter",newfsType);}
return true;};Fdl.Collection.prototype.resetFilter=function(){if(!this.isSearch())return false;this.setValue("se_filter",'');return true;};Fdl.Collection.prototype.getFilters=function(filter){if(!this.isSearch())return null;var xmlfilters=this.getValue("se_filter");if(xmlfilters&&(xmlfilters.length>0)){var filters=[];var xml;var ojs;for(var i=0;i<xmlfilters.length;i++){xml=Fdl.text2xml(xmlfilters[i]);ojs=Fdl.xml2json(xml);if(ojs.filter&&ojs.filter.criteria){if(ojs.filter.criteria.operator||ojs.filter.criteria.or||ojs.filter.criteria.and)ojs.filter.criteria=[ojs.filter.criteria];}
if(ojs.filter.criteria){for(var j=0;j<ojs.filter.criteria.length;j++){if((ojs.filter.criteria[j].or)&&(ojs.filter.criteria[j].or.operator))ojs.filter.criteria[j]=ojs.filter.criteria[j].or;if((ojs.filter.criteria[j].and)&&(ojs.filter.criteria[j].and.operator))ojs.filter.criteria[j]=ojs.filter.criteria[j].and;}}
var of=new Fdl.DocumentFilter(ojs.filter);filters.push(of);}
return filters;}else{var se_attrids=this.getValue('se_attrids');console.log("old",se_attrids);}};Fdl.getHomeFolder=function(){var u=Fdl.getUser();if(u!=null&&u.id){var idhome='FLDHOME_'+u.id;var h=new Fdl.Collection({id:idhome});if(h&&h.isAlive())return h;}
return null;};Fdl.getDesktopFolder=function(){if(Fdl._desktopFolder)return Fdl._desktopFolder;var u=Fdl.getUser();if(u!=null&&u.id){var idhome='FLDDESKTOP_'+u.id;var h=new Fdl.Collection({id:idhome});if(h&&h.isAlive()){Fdl._desktopFolder=h;return h;}}
return null;};Fdl.getOfflineFolder=function(){if(Fdl._offlineFolder)return Fdl._offlineFolder;var u=Fdl.getUser();if(u!=null&&u.id){var idhome='FLDOFFLINE_'+u.id;var h=new Fdl.Collection({id:idhome});if(h&&h.isAlive()){Fdl._offlineFolder=h;return h;}}
return null;};Fdl.DocumentFilter=function(config){if(config){for(var i in config)this[i]=config[i];}};Fdl.DocumentFilter.prototype={family:null,criteria:null,sql:null,toString:function(){return'Fdl.DocumentFilter';},getCriteria:function(clone){if(clone)return Fdl.cloneObject(this.criteria);else return this.criteria;},linearize:function(ca,ol){var l=[];if(!ol)ol='and';var lp=false;var rp=false;var top=(!c);var c;if(!ca)c=this.getCriteria(true);else c=Fdl.cloneObject(ca);if(!c)return l;for(var i=0;i<c.length;i++){if(c[i].operator){if(i>0)c[i].ol=ol;c[i].lp=lp;c[i].rp=rp;l.push(c[i]);}else if(c[i].or||c[i].and||c[i].length){var ln=[];if(c[i].or)ln=this.linearize(c[i].or,'or');else if(c[i].and)ln=this.linearize(c[i].and,'and');else if(c[i].length)ln=this.linearize(c[i],'and');else console.log("ERROR ADD",c[i]);if(ln.length>0){if(!ln[0].lp){ln[0].lp=true;ln[ln.length-1].rp=true;}
ln[0].ol=ol;for(var j=0;j<ln.length;j++){l.push(ln[j]);}}}}
if(top&&l.length>0)l[0].ol=null;return l;},unLinearize:function(la,level){if(!level)level=0;if(level>4){console.log('recursion detect');return;}
var l=Fdl.cloneObject(la);var c=[];if(l.length==0)return c;if(l.length==1){l[0].ol=null;l[0].lp=null;l[0].rp=null;return[l[0]];}
var ol=l[1].ol;var onlyand=true;for(var i=1;i<l.length;i++){if(l[i].ol!='and')onlyand=false;}
if(onlyand){for(var i=0;i<l.length;i++){l[i].ol=null;l[i].lp=null;l[i].rp=null;if(l[i].ul)c.push(l[i].ul);else c.push(l[i]);}}else{var onlyor=true;for(var i=1;i<l.length;i++){if(l[i].ol!='or')onlyor=false;}
if(onlyor){var cor={or:[]};for(var i=0;i<l.length;i++){l[i].ol=null;l[i].lp=null;l[i].rp=null;if(l[i].ul)cor.or.push(l[i].ul);else cor.or.push(l[i]);}
c.push(cor);}else{var pa=0;var bp=false;for(var i=1;i<l.length;i++){if((!bp)&&(l[i].ol=='and')&&(!l[i].lp)&&(!l[i].rp)){pa=i-1;bp=true;l[i].lp=false;l[i].rp=false;if(i==l.length-1){l[pa].lp=true;l[i].rp=true;}}else if(bp&&(!l[i].lp)&&(!l[i].rp)&&(l[i].ol=='and')&&(i<(l.length-1))){l[i].lp=false;l[i].rp=false;}else if(bp&&(!l[i].lp)&&(!l[i].rp)&&(l[i].ol=='and')&&(i==l.length-1)){l[pa].lp=true;l[i].rp=true;}else if(bp&&((l[i].ol!='and')||(l[i].lp)||(l[i].rp))){l[i-1].rp=true;l[pa].lp=true;bp=false;}}
var cp=0;var lu;var wu;var wi=0;var nl=[];for(var i=0;i<l.length;i++){if((l[i].lp)){wi=i;}
if((l[i].rp)){wu=l.slice(wi,i+1);lu=this.unLinearize(wu,level+1);nl.push({ol:l[wi].ol,ul:lu});}
if((!l[i].lp)&&(!l[i].rp)&&(cp==0)){nl.push(l[i]);}
if(l[i].lp)cp++;if(l[i].rp)cp--;}
return this.unLinearize(nl,level+1);}}
return c;},normalize:function(){if(this.criteria){for(var j=0;j<this.criteria.length;j++){if(this.criteria[j].or||this.criteria[j].and){var ic=this.criteria[j].or;if(!ic)ic=this.criteria[j].and;for(var i=0;i<ic.length;i++){if(ic[i].length>0){ic[i]={and:ic[i]};}}}}}
return this;}};Fdl.DocumentSelection=function(config){this.selectionItems=[];this.mainSelector='none';if(config){for(var i in config)this[i]=config[i];}};Fdl.DocumentSelection.prototype={mainSelector:'none',selectionItems:[],collectionId:null,filter:null,context:null,insertToList:function(config){var id=0;if(config){if(config.document&&config.document.getProperty){config.id=config.document.getProperty('initid');if((!this.context)&&(config.document.context))this.context=config.document.context;}
if(config.id){for(var i=0;i<this.selectionItems.length;i++){if(this.selectionItems[i]==config.id)return false;}
this.selectionItems.push(config.id);return true;}}
return null;},removeFromList:function(config){if(config){for(var i=0;i<this.selectionItems.length;i++){if(this.selectionItems[i]==config.id){if(this.selectionItems.length==1){this.selectionItems=[];}else{if(i<(this.selectionItems.length-1))this.selectionItems[i]=this.selectionItems[this.selectionItems.length-1];this.selectionItems.pop();}
return true;}}}
return false;},toJSON:function(key){var o={};for(var i in this){if((typeof this[i]!='function')&&(i!='context'))o[i]=this[i];}
return JSON.parse(JSON.stringify(o));},clearSelection:function(config){this.selectionItems=[];},invertSelection:function(config){if(this.mainSelector=='none')this.mainSelector='all';else this.mainSelector='none';},getDocumentIdList:function(config){if(this.mainSelector=='all'){}else{return this.selectionItems;}},getDocumentList:function(config){if(this.mainSelector=='all'){if(this.collectionId){var tfilter=[];for(var i=0;i<this.selectionItems.length;i++){tfilter.push({operator:'!=',left:'id',right:this.selectionItems[i]});}
var f=new Fdl.DocumentFilter({criteria:tfilter});var c=this.context.getDocument({id:this.collectionId,usecache:true});return c.getContent({filter:f});}}else{var g=this.context.createGroupRequest();for(var i=0;i<this.selectionItems.length;i++){var o={};o['d'+i]=g.getDocument({id:this.selectionItems[i]});g.addRequest(o);}
var r=g.submit();if(r){var rt=[];var d;for(var i=0;i<this.selectionItems.length;i++){d=r.get('d'+i);if(d)rt.push(d);}
return rt;}}
return null;},setAllCollection:function(config){if(config){if(config.collection){if(config.collection.isAlive()){if(config.collection.isCollection()){this.collectionId=config.collection.getProperty('initid');this.mainSelector='all';if((!this.context)&&(config.collection.context))this.context=config.collection.context;return true;}else config.collection.context.setErrorMessage('document is not a collection');}else config.collection.context.setErrorMessage('document is not alive');return false;}}
return null;},toString:function(){return'Fdl.DocumentSelection';},count:function(){if(this.mainSelector=='all'){var count=this.totalCount;return count-this.selectionItems.length;}else{return this.selectionItems.length;}}};Fdl.User=function(config){if(config&&config.context)this.context=config.context;if(config&&config.data){this.affect(config.data);}else{var data=this.context.retrieveData({app:'DATA',action:'USER'});if(data)this.affect(data);else return false;}};Fdl.User.prototype={id:null,login:null,firstname:null,lastname:null,mail:null,mail:null,info:new Object(),context:Fdl,affect:function(data){if(data){if(!data.error){this._data=data;if(data.info)this.completeData(data.info);return true;}else{this.context.setErrorMessage(data.error);}}
return false;},toString:function(){return'Fdl.User';}};Fdl.User.prototype.completeData=function(data){if(data){for(var i in data)this.info[i]=data[i];this.id=data.id;this.login=data.login;this.firstname=data.firstname;this.lastname=data.lastname;this.locale=data.locale;}};Fdl.User.prototype.getDisplayName=function(){if(this.info){return this.info.firstname+' '+this.info.lastname;}
return null;};Fdl.User.prototype.getInfo=function(){if(this.info){return this.info;}
return null;};Fdl.User.prototype.getLocaleFormat=function(){if(this._data.localeFormat){return this._data.localeFormat;}
return null;};Fdl.User.prototype.getUserDocumentIdentificator=function(){if(this.info){return parseInt(this.info.fid);}
return null;};Fdl.Attribute=function(config){if(config){this._data=new Object();for(var name in config){switch(name){case'id':this.id=config[name];break;case'docid':this.famId=config[name];break;case'labelText':this.label=config[name];break;case'type':case'options':case'usefor':case'mvisibility':case'visibility':this[name]=config[name];break;default:this._data[name]=config[name];break;}}
this.rank=config.rank||0;this.parentId=config.parentId||0;}};Fdl.Attribute.prototype={id:null,type:null,famId:null,parentId:null,label:null,usefor:null,options:null,visibility:null,mvisibility:null,options:new Object(),_isNode:null,_child:null,toString:function(){return'Fdl.Attribute';},getLabel:function(){return this.label;},getVisibility:function(){if(this.mvisibility){return this.mvisibility;}
return this.visibility;},getOption:function(optkey){if(this.options&&this.options[optkey]){return this.options[optkey];}
return null;},getParent:function(){if(!this.parentId)
return null;var oa=this._family.getAttribute(this.parentId);return oa;},getChildAttributes:function(){if(this._childs)
return this._childs;this._chids=[];var als=this._family.getAttributes();for(var aid in als){if(als[aid].parentId==this.id)
this._chids.push(this._family.getAttribute(aid));}
return this._chids;},isLeaf:function(){return(this._isNode!==null&&(!this._isNode));},isNode:function(){return(this._isNode!==null&&this._isNode);}};Fdl.Attribute.prototype.getFilterCriteria=function(){if(this._family){var top=this._family.getSearchCriteria();if(top){if(top[this.type]){if(this.type=="docid"){if(this.relationFamilyId){return top[this.type];}else{var ftop=[];for(var i in top[this.type]){if(top[this.type][i].operator!='=~*')
ftop.push(top[this.type][i]);}
return ftop;}}else
return top[this.type];}else
return[];}}
return false;};Fdl.Attribute.prototype.isSortable=function(){if(this.isLeaf()&&(!this.inArray())&&(this.type!='longtext')&&(this.type!='htmltext')&&(this.type!='color')&&(this.type!='image')&&(this.type!='file')){return true;}else{return false;}};Fdl.LeafAttribute=function(config){Fdl.Attribute.call(this,config);if(config){for(var name in config){switch(name){case'phpconstraint':this.constrain=config[name];break;case'ordered':this.rank=config[name];break;case'isInTitle':this.inTitle=config[name];break;case'isInAbstract':this.inAbstract=config[name];break;case'link':this[name]=config[name];break;case'needed':this[name]=config[name];break;default:this._data[name]=config[name];break;}}
if(!this.rank)
this.rank=0;}};Fdl.LeafAttribute.prototype=new Fdl.Attribute();Fdl.LeafAttribute.prototype._isNode=false;Fdl.LeafAttribute.prototype.rank=0;Fdl.LeafAttribute.prototype.needed=null;Fdl.LeafAttribute.prototype.inAbstract=null;Fdl.LeafAttribute.prototype.inTitle=null;Fdl.LeafAttribute.prototype.hasConstrain=function(){return this.constrain!='';};Fdl.LeafAttribute.prototype.toString=function(){return'Fdl.LeafAttribute';};Fdl.LeafAttribute.prototype.hasInputHelp=function(){return(this._data.phpfunc&&this._data.phpfile&&this.type!='enum');};Fdl.LeafAttribute.prototype.inArray=function(){if(this.isLeaf()&&this.parentId&&this.getParent().type=='array')
return true;return false;};Fdl.LeafAttribute.prototype.getSortKey=function(){return this.id;};Fdl.TextAttribute=function(config){Fdl.LeafAttribute.call(this,config);};Fdl.TextAttribute.prototype=new Fdl.LeafAttribute();Fdl.TextAttribute.prototype.toString=function(){return'Fdl.TextAttribute';};Fdl.EnumAttribute=function(config){Fdl.LeafAttribute.call(this,config);};Fdl.EnumAttribute.prototype=new Fdl.LeafAttribute();Fdl.EnumAttribute.prototype.toString=function(){return'Fdl.EnumAttribute';};Fdl.EnumAttribute.prototype.getEnumItems=function(){if(this._data.enumerate){var t=new Array();for(var i in this._data.enumerate){if(typeof this._data.enumerate[i]!='function')
t.push({key:i,label:this._data.enumerate[i]});}
return t;}
return null;};Fdl.EnumAttribute.prototype.getEnumLabel=function(config){if(config&&config.key){if(this._data.enumerate){for(var i in this._data.enumerate){if(i==config.key)
return this._data.enumerate[i];}}}
return null;};Fdl.EnumAttribute.prototype.isMultiple=function(){return this.getOption('multiple')=='yes';};Fdl.MenuAttribute=function(config){Fdl.Attribute.call(this,config);};Fdl.MenuAttribute.prototype=new Fdl.Attribute();Fdl.MenuAttribute.prototype.toString=function(){return'Fdl.MenuAttribute';};Fdl.ColorAttribute=function(config){Fdl.LeafAttribute.call(this,config);};Fdl.ColorAttribute.prototype=new Fdl.LeafAttribute();Fdl.ColorAttribute.prototype.toString=function(){return'Fdl.ColorAttribute';};Fdl.ThesaurusAttribute=function(config){Fdl.LeafAttribute.call(this,config);};Fdl.ThesaurusAttribute.prototype=new Fdl.LeafAttribute();Fdl.ThesaurusAttribute.prototype.toString=function(){return'Fdl.ThesaurusAttribute';};Fdl.RelationAttribute=function(config){Fdl.LeafAttribute.call(this,config);if(this._data)
this.relationFamilyId=this._data.format;if(config&&config.relationFamilyId)
this.relationFamilyId=config.relationFamilyId;};Fdl.RelationAttribute.prototype=new Fdl.LeafAttribute();Fdl.RelationAttribute.prototype.toString=function(){return'Fdl.RelationAttribute';};Fdl.RelationAttribute.prototype.getTitle=function(){alert('do not use relationAttribut::getTitle');return this._family.getValue(this.id+'_title');};Fdl.RelationAttribute.prototype.getSortKey=function(){var atitle=this.getOption('doctitle');if(atitle){if(atitle=='auto')
return this.id+'_title';else
return atitle;}
return null;};Fdl.RelationAttribute.prototype.retrieveProposal=function(config){var data=this._family.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'retrieveproposal',attributeId:this.id,relationFamilyId:this.relationFamilyId,id:(this._family)?(this._family.id?this._family.id:this._family.getProperty('fromid')):null},config);if(data){if(!data.error){return data.proposal;}else{this._family.context.setErrorMessage(data.error);}}else{this._family.context.setErrorMessage('retrieveProposal: no data');}
return null;};Fdl.DateAttribute=function(config){Fdl.LeafAttribute.call(this,config);};Fdl.DateAttribute.prototype=new Fdl.LeafAttribute();Fdl.DateAttribute.prototype.toString=function(){return'Fdl.DateAttribute';};Fdl.FileAttribute=function(config){Fdl.LeafAttribute.call(this,config);};Fdl.FileAttribute.prototype=new Fdl.LeafAttribute();Fdl.FileAttribute.prototype.toString=function(){return'Fdl.FileAttribute';};Fdl.FileAttribute.prototype.getUrl=function(v,documentId,config){if(v){var sinline='yes';var swidth=false;var stype=false;var spage=false;var index=-1;if(config){if(config.inline===false)
sinline='no';if(config.type)
stype=config.type;if(config.width)
swidth=parseInt(config.width);if(config.page!==null)
spage=parseInt(config.page);if(typeof(config.index)=='number'){index=parseInt(config.index);v=v[index];}}
var p1=v.indexOf('|',0);var p2=v.indexOf('|',p1+1);if(p2==-1)
p2=v.length;if((p1>0)&&(p2>p1)){var vid=v.substring(p1+1,p2);var url=this._family.context.url
+'?app=FDL&action=EXPORTFILE&inline='+sinline
+'&cache=no&vid='+vid+'&docid='+documentId
+'&attrid='+this.id+'&index='+index;if(swidth)
url+='&width='+swidth;if(stype)
url+='&type='+stype;if(spage!==false)
url+='&page='+spage;return url;}}
return null;};Fdl.FileAttribute.prototype.getDavUrl=function(v,documentId){data=this._family.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'davurl',id:documentId,vid:this.getVaultId(v)});if(data){if(!data.error){var url=data.url;return url;}else{this._family.context.setErrorMessage(data.error);}}
return null;};Fdl.FileAttribute.prototype.getFileName=function(v,config){if(v){if(config&&typeof(config.index)=='number'){index=parseInt(config.index);v=v[index];}
var p1=v.indexOf('|',0);var p2=v.indexOf('|',p1+1);if((p2>0)&&(p2<v.length)){return v.substring(p2+1,v.length);}}
return null;};Fdl.FileAttribute.prototype.getVaultId=function(v){if(v){var p1=v.indexOf('|',0);var p2=v.indexOf('|',p1+1);if((p1>0)&&(p2>p1)){var vid=v.substring(p1+1,p2);return vid;}}
return null;};Fdl.NumericAttribute=function(config){Fdl.LeafAttribute.call(this,config);};Fdl.NumericAttribute.prototype=new Fdl.LeafAttribute();Fdl.NumericAttribute.prototype.toString=function(){return'Fdl.NumericAttribute';};Fdl.NodeAttribute=function(config){Fdl.Attribute.call(this,config);};Fdl.NodeAttribute.prototype=new Fdl.Attribute();Fdl.NodeAttribute.prototype._isNode=true;Fdl.NodeAttribute.prototype.toString=function(){return'Fdl.NodeAttribute';};Fdl.ArrayAttribute=function(config){Fdl.NodeAttribute.call(this,config);};Fdl.ArrayAttribute.prototype=new Fdl.NodeAttribute();Fdl.ArrayAttribute.prototype.toString=function(){return'Fdl.ArrayAttribute';};Fdl.ArrayAttribute.prototype.getElements=function(){return this.getChildAttributes();};Fdl.ArrayAttribute.prototype.getArrayValues=function(config){var oas=this.getElements();var rv=[];var vc;if(oas.length>0&&oas[0].getValue().length>0){var i=0;for(i=0;i<oas[0].getValue().length;i++){rv[i]=new Object();}
for(i=0;i<oas.length;i++){vc=oas[i].getValue();for(var ic=0;ic<vc.length;ic++){rv[ic][oas[i].id]=vc[ic];}}}
return rv;};Fdl.TabAttribute=function(config){Fdl.NodeAttribute.call(this,config);};Fdl.TabAttribute.prototype=new Fdl.NodeAttribute();Fdl.TabAttribute.prototype.toString=function(){return'Fdl.TabAttribute';};Fdl.FrameAttribute=function(config){Fdl.NodeAttribute.call(this,config);};Fdl.FrameAttribute.prototype=new Fdl.NodeAttribute();Fdl.FrameAttribute.prototype.toString=function(){return'Fdl.FrameAttribute';};Fdl.SearchDocument=function(config){Fdl.Document.call(this,config);if(config&&config.filter)this.filter=config.filter;};Fdl.SearchDocument.prototype=new Fdl.Document();Fdl.SearchDocument.prototype.toString=function(){return'Fdl.SearchDocument';};Fdl.SearchDocument.prototype._count=-1;Fdl.SearchDocument.prototype.start=0;Fdl.SearchDocument.prototype.slice=50;Fdl.SearchDocument.prototype.mode='word';Fdl.SearchDocument.prototype.filter=null;Fdl.SearchDocument.prototype.orderBy=null;Fdl.SearchDocument.prototype.search=function(config){if(config){if(typeof(config.start)==="undefined")config.start=this.start;if(typeof(config.slice)==="undefined")config.slice=this.slice;if(typeof(config.mode)==="undefined")config.mode=this.mode;}
var data=null;if(config&&config.data){data=config.data;}else{if(config&&config.filter){if(typeof(config.filter)=='object')config.filter=JSON.stringify(config.filter);}else if(this.filter){if(!config)config={};config.filter=JSON.stringify(this.filter);}
data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'search'},config);}
if(data){this._info=data.info;if(!data.error){data.context=this.context;return new Fdl.DocumentList(data);}else{this.context.setErrorMessage(data.error);}}else return false;};Fdl.SearchDocument.prototype.getFamilies=function(config){if(!config)config=new Object();config.famid=-1;config.mode='regexp';config.searchProperty='title';config.slice="ALL";return this.search(config);};Fdl.SearchDocument.prototype.getSubFamilies=function(config){if((!config)||(!config.famid)){this.context.setErrorMessage('no family identifier set');return null;}
var data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'getsubfamilies'},config);if(data){this._info=data.info;if(!data.error){data.context=this.context;return new Fdl.DocumentList(data);}else{this.context.setErrorMessage(data.error);}}
return null;};Fdl.DocumentHistory=function(config){if(config){var data;if(config.context)this.context=config.context;if(config.id){this.id=config.id;this._data=null;data=this.context.retrieveData({app:'DATA',action:'DOCUMENT',method:'history'},config);if(data&&data.error){this.error=data.error;return false;}
if(data){this.items=data.items;this.revisions=[];for(var i=0;i<data.revisions.length;i++){if(!data.revisions[i].error){this.revisions.push(this.context.getDocument({latest:false,data:data.revisions[i]}));}}}}}};Fdl.DocumentHistory.prototype={id:null,error:null,items:null,toString:function(){return'Fdl.DocumentHistory';},getItems:function(id){if(!id)return this.items;var it=[];for(var i=0;i<this.items.length;i++){if(this.items[i].id==id)it.push(this.items[i]);}
return it;},getRevisions:function(){return this.revisions;}};Fdl.Application=function(config){if(config&&config.context){var data=null;this.context=config.context;if(config.name){data=this.context.retrieveData({app:'DATA',action:'APPLICATION',method:'get'},config);if(data)this.completeData(data);}}};Fdl.Application.prototype={id:null,name:null,description:null,icon:null,version:null,_data:null,context:null,affect:function(data){if(data){if(!data.error){this._data=data;if(data)
this.completeData(data);return true;}else{this.context.setErrorMessage(data.error);}}
return false;},toString:function(){return'Fdl.Application';}};Fdl.Application.prototype.completeData=function(data){if(data){if(!data.error){this._data=data;this.id=this._data.id;this.name=this._data.name;this.description=this._data.description;this.label=this._data.label;this.available=this._data.available;this.icon=this._data.icon;this.displayable=this._data.displayable;this.version=this._data.version;}else{this.context.setErrorMessage(data.error);}}};Fdl.Application.prototype.getParameter=function(config){if(config&&config.id){var data=this.context.retrieveData({app:'DATA',action:'APPLICATION',method:'getParameter',id:config.id,name:this.name});if(data){if(!data.error){if(data.value)
return data.value;}else{this.context.setErrorMessage(data.error);}}}else
this.context.setErrorMessage("no parameter id set");return null;};Fdl.Application.prototype.setParameter=function(config){if(config&&config.id){var data=this.context.retrieveData({app:'DATA',action:'APPLICATION',method:'setParameter',name:this.name,id:config.id,value:config.value});if(data){if(!data.error){if(data.value)
return data.value;}else{Fdl.setErrorMessage(data.error);}}}else
Fdl.setErrorMessage("no parameter id set");return null;};Fdl.Application.prototype.getExecutableActions=function(config){if(config&&config.reset)this._actions=null;if(this._actions)return this._actions;var data=this.context.retrieveData({app:'DATA',action:'APPLICATION',method:'getExecutableActions',name:this.name});if(data){if(!data.error){if(data.actions)
this._actions=[];for(var i=0;i<data.actions.length;i++){this._actions.push(new Fdl.Action({application:this,data:data.actions[i]}));}
return this._actions;}else{this.context.setErrorMessage(data.error);}}
return null;};Fdl.Application.prototype.canExecuteAction=function(config){if((!config)||(!config.name)){this.context.setErrorMessage(this.context._("data:action name not set"));return null;}
if(!this._actions){this.getExecutableActions();}
if(!this._actions){return null;}
for(var i=0;i<this._actions.length;i++){if(this._actions[i].name==config.name)return true;}
return false;};Fdl.getParameter=function(config){if(config){if(config.id){if(!this.application)
this.application=new Fdl.Application();return this.application.getParameter(config);}}};Fdl.setParameter=function(config){if(config){if(config.id){if(!this.application)
this.application=new Fdl.Application();return this.application.setParameter(config);}}};Fdl.Action=function(config){if(config){if(config.application)this.application=config.application;if((!this.context)&&this.application.context)this.context=this.application.context;if(config.data){this.completeData(config.data);}}};Fdl.Action.prototype={id:null,name:null,label:null,_data:null,context:null,toString:function(){return'Fdl.Action';}};Fdl.Action.prototype.completeData=function(data){if(data){if(!data.error){this._data=data;this.id=this._data.id;this.name=this._data.name;this.label=this._data.label;}else{this.context.setErrorMessage(data.error);}}};Fdl.Family=function(config){Fdl.Document.call(this,config);if(this.getProperty('doctype')!='C'){this._data=null;this._attributes=null;this.id=null;this.context.setErrorMessage('it is not a family document');}};Fdl.Family.prototype=new Fdl.Document();Fdl.Family.prototype.toString=function(){return'Fdl.Family';};Fdl.Family.prototype.addAttribute=function(config){if(!config){this.context.setErrorMessage('addAttribute: need parameter');return false;}
if((!config.attributeId)||(!config.label)||(!config.type)){this.context.setErrorMessage('addAttribute: incomplete definition');return false;}
config.method='addattribute';return this.callMethod(config);};Fdl.Family.prototype.modifyAttribute=function(config){if(!config){this.context.setErrorMessage('modifyAttribute: need parameter');return false;}
if((!config.attributeId)){this.context.setErrorMessage('modifyAttribute: incomplete definition');return false;}
if(config.options&&typeof config.options=='object')config.options=JSON.stringify(config.options);config.method='modifyattribute';return this.callMethod(config);};Fdl.Family.prototype.removeAttribute=function(config){if(!config){this.context.setErrorMessage('removeAttribute: need parameter');return false;}
if((!config.attributeId)){this.context.setErrorMessage('removeAttribute: incomplete definition');return false;}
config.method='removeattribute';return this.callMethod(config);};Fdl.Family.prototype.getParameterValue=function(idParameter){if(this._data){var p=this._data.values.param;var tp=p.substring(1,p.length-1).split('][');var s;for(var i=0;i<tp.length;i++){s=tp[i].split('|');if((s.length==2)&&(s[0]==idParameter)){return s[1];}}}
return null;};Fdl.Workflow=function(config){if(config.needWorkflow!==false)config.needWorkflow=true;Fdl.Document.call(this,config);if(this.getProperty('doctype')!='W'){this._data=null;this._attributes=null;this.id=null;Fdl.setErrorMessage('it is not a workflow document');}};Fdl.Workflow.prototype=new Fdl.Document();Fdl.Workflow.prototype.toString=function(){return'Fdl.Workflow';};Fdl.Workflow.prototype.getStates=function(){if((!this._data)||(!this._data.workflow))return null;return this._data.workflow.states;};Fdl.Workflow.prototype.getTransitions=function(){if((!this._data)||(!this._data.workflow))return null;return this._data.workflow.transitions;};Fdl.Workflow.prototype.getTransitionTypes=function(){if((!this._data)||(!this._data.workflow))return null;return this._data.workflow.transitionTypes;};Fdl.Workflow.prototype.addTransition=function(config){if((!this._data)||(!this._data.workflow))return null;var states=this.getStates();var types=this.getTransitionTypes();if(!states[config.start]){Fdl.setErrorMessage('addTransition: start state not exists :'+config.start);return null;}
if(!states[config.finish]){Fdl.setErrorMessage('addTransition: finish state not exists :'+config.finish);return null;}
if(!types[config.transitionType]){Fdl.setErrorMessage('addTransition: transition type  not exists :'+config.transitionType);return null;}
config.method='addTransition';return this.callMethod(config);};Fdl.Workflow.prototype.removeTransition=function(config){if((!this._data)||(!this._data.workflow))return null;var states=this.getStates();var types=this.getTransitionTypes();if(!states[config.start]){Fdl.setErrorMessage('addTransition: start state not exists :'+config.start);return null;}
if(!states[config.finish]){Fdl.setErrorMessage('addTransition: finish state not exists :'+config.finish);return null;}
config.method='removeTransition';return this.callMethod(config);};Fdl.Workflow.prototype.addState=function(config){if((!this._data)||(!this._data.workflow))return null;var states=this.getStates();if(!config){Fdl.setErrorMessage('addState:  missing key');return null;}
if(!config.key){Fdl.setErrorMessage('addState:  missing key');return null;}
var myRegxp=/^([a-z0-9_-]+)$/;if(myRegxp.test(config.key)==false){Fdl.setErrorMessage('addState: syntax error in key , must be only alphanumeric:'+config.key);return null;}
if(states[config.key]){Fdl.setErrorMessage('addState:  state already exist :'+config.key);return null;}
config.method='addState';return this.callMethod(config);};Fdl.Workflow.prototype.modifyState=function(config){if((!this._data)||(!this._data.workflow))return null;var states=this.getStates();if(!config){Fdl.setErrorMessage('modifystate:  missing key');return null;}
if(!config.key){Fdl.setErrorMessage('modifystate:  missing key');return null;}
if(!states[config.key]){Fdl.setErrorMessage('modifystate:  state not exist :'+config.key);return null;}
config.method='modifystate';return this.callMethod(config);};Fdl.Workflow.prototype.removeState=function(config){if((!this._data)||(!this._data.workflow))return null;var states=this.getStates();if(!config){Fdl.setErrorMessage('removestate:  missing key');return null;}
if(!config.key){Fdl.setErrorMessage('removestate:  missing key');return null;}
if(!states[config.key]){Fdl.setErrorMessage('removestate:  state not exist :'+config.key);return null;}
config.method='removestate';return this.callMethod(config);};Fdl.Workflow.prototype.addTransitionType=function(config){if((!this._data)||(!this._data.workflow))return null;var types=this.getTransitionTypes();if(!config){Fdl.setErrorMessage('addTransitiontype:  missing key');return null;}
if(!config.key){Fdl.setErrorMessage('addTransitiontype:  missing key');return null;}
if(types[config.key]){Fdl.setErrorMessage('addTransitiontype: type already exists :'+config.key);return null;}
config.method='addTransitionType';return this.callMethod(config);};Fdl.Workflow.prototype.modifyTransitionType=function(config){if((!this._data)||(!this._data.workflow))return null;var types=this.getTransitionTypes();if(!config){Fdl.setErrorMessage('modifyTransitiontype:  missing key');return null;}
if(!config.key){Fdl.setErrorMessage('modifyTransitiontype:  missing key');return null;}
if(!types[config.key]){Fdl.setErrorMessage('modifyTransitiontype: type not exists :'+config.key);return null;}
config.method='modifyTransitionType';return this.callMethod(config);};Fdl.Workflow.prototype.removeTransitionType=function(config){if((!this._data)||(!this._data.workflow))return null;var types=this.getTransitionTypes();if(!config){Fdl.setErrorMessage('removeTransitiontype:  missing key');return null;}
if(!config.key){Fdl.setErrorMessage('removeTransitiontype:  missing key');return null;}
if(!types[config.key]){Fdl.setErrorMessage('removeTransitiontype: type not exists :'+config.key);return null;}
config.method='removeTransitionType';return this.callMethod(config);};Fdl.GroupRequest=function(config){if(config){this.context=config.context;}
this.requestItems=[];};Fdl.GroupRequest.prototype={context:null,requestItems:[]};Fdl.GroupRequest.prototype.toString=function(){return'Fdl.GroupRequest';};Fdl.GroupRequest.prototype.addRequest=function(request){this.requestItems.push(request);return true;};Fdl.GroupRequest.prototype.getRequest=function(name){for(var i=0;i<this.requestItems.length;i++){if(this.requestItems[i][name])return this.requestItems[i][name];}
return null;};Fdl.GroupRequest.prototype.getDocument=function(config){return{method:'',config:config};};Fdl.GroupRequest.prototype.getSelection=function(selection){return{method:'getSelection',config:selection};};Fdl.GroupRequest.prototype.get=function(name){return new Fdl.GroupRequestDocument({gr:this,name:name});};Fdl.GroupRequest.prototype.foreach=function(name){return new Fdl.GroupRequestCollection({gr:this,name:name});};Fdl.GroupRequest.prototype.submit=function(){if(this.context){var r=this.context.retrieveData({app:'DATA',action:'GROUPREQUEST'},{request:JSON.stringify(this.requestItems)});if(r.error){this.context.setErrorMessage(r.error);return null;}else{return new Fdl.GroupRequestResult({gr:this,result:r});}}
return null;};Fdl.GroupRequestDocument=function(config){if(config){this.config=config;}};Fdl.GroupRequestDocument.prototype={callMethod:function(method,config){return{variable:this.config.name,method:method,config:config};},toString:function(){return'Fdl.GroupRequestDocument';}};Fdl.GroupRequestCollection=function(config){if(config){this.config=config;}};Fdl.GroupRequestCollection.prototype={callMethod:function(method,config){return{iterative:true,variable:this.config.name,method:method,config:config};},toString:function(){return'Fdl.GroupRequestCollection';}};Fdl.GroupRequestResult=function(config){if(config){if(config.gr)this.gr=config.gr;if(config.result)this.result=config.result;}};Fdl.GroupRequestResult.prototype={gr:null,get:function(name){if(this.gr){var request=this.gr.getRequest(name);if(request){if(this.result[name]){var res1=this.result[name];if(res1.error){this.gr.context.setErrorMessage('GroupRequestResult::get : '+res1.error);return false;}else if(res1.properties&&res1.properties.id>0){var rd=this.gr.context.getDocument({data:res1});try{if(rd[request.method]){var rm=rd[request.method]({norequest:true});return rm;}}catch(ex){}
return rd;}else{if(request.method&&request.variable){var rd=this.get(request.variable);if(rd){try{if(request.iterative){var ld;var lr=[];var ldr;var lerr='';for(var li=0;li<res1.iterative.length;li++){lerr=res1.iterative[li].error;res1.iterative[li].error='';ld=this.gr.context.getDocument({data:res1.iterative[li]});try{if(ld[request.method]){if(lerr)ldr=false;else ldr=ld[request.method]({norequest:true,data:res1.iterative[li]});res1.iterative[li].error=lerr;lr.push({error:lerr,document:ld,result:ldr});}}catch(ex){}}
return lr;}else if(rd[request.method]){var rm=rd[request.method]({norequest:true,data:res1});return rm;}}catch(ex){}}}}
return res1;}else{this.gr.context.setErrorMessage('GroupRequestResult::get :no result for '+name);}}}},toString:function(){return'Fdl.GroupRequestResult';},getError:function(name){if(this.gr){var request=this.gr.getRequest(name);if(request){if(this.result[name]){return this.result[name].error;}}}}};